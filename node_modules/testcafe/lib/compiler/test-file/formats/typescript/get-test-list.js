"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.getTypeScriptTestListFromCode = exports.getTypeScriptTestList = void 0;
const typescript_1 = __importDefault(require("typescript"));
const lodash_1 = require("lodash");
const test_file_parser_base_1 = require("../../test-file-parser-base");
const typescript_configuration_1 = __importDefault(require("../../../../configuration/typescript-configuration"));
function replaceComments(code) {
    return code.replace(/\/\*[\s\S]*?\*\/|([^\\:]|^)\/\/.*$/gm, match => {
        const lastSymbol = match.indexOf('\n') > -1 ? '\n' : ' ';
        return lodash_1.repeat(' ', match.length + lastSymbol);
    });
}
class TypeScriptTestFileParser extends test_file_parser_base_1.TestFileParserBase {
    constructor() {
        super(typescript_1.default.SyntaxKind);
    }
    getComputedNameString({ pos, end }) {
        const templatePos = this.getLocationByOffsets(pos, end);
        return test_file_parser_base_1.TestFileParserBase.formatComputedName(templatePos.loc.start.line);
    }
    getTokenType(token) {
        return token.kind;
    }
    getCalleeToken(token) {
        return token.expression;
    }
    getMemberFnName(token) {
        return token.expression.name.text;
    }
    getKeyValue(prop) {
        const { name, initializer } = prop;
        return {
            key: name.text,
            value: this.getStringValue(initializer)
        };
    }
    getFixedStartOffset(start) {
        let fixedStartOffset = start;
        while (/\s/.test(this.codeWithoutComments[fixedStartOffset]))
            ++fixedStartOffset;
        return fixedStartOffset;
    }
    getLocationByOffsets(start, end) {
        const fixedStart = this.getFixedStartOffset(start);
        const codeArr = this.codeArr;
        const loc = { start: null, end: null };
        let line = codeArr[0];
        let startTmp = fixedStart;
        let endTmp = end;
        for (let lineNumber = 1; lineNumber <= codeArr.length; ++lineNumber, line = codeArr[lineNumber - 1]) {
            startTmp -= line.length + 1;
            endTmp -= line.length + 1;
            if (startTmp < 0 && !loc.start)
                loc.start = { line: lineNumber, column: line.length + startTmp + 1 };
            if (endTmp <= 0 || lineNumber === codeArr.length - 1) {
                loc.end = { line: lineNumber, column: line.length + endTmp + 1 };
                break;
            }
        }
        return { loc, start: fixedStart, end };
    }
    getRValue(token) {
        return token.declarationList.declarations[0].initializer;
    }
    getStringValue(token) {
        const stringTypes = [this.tokenType.StringLiteral, this.tokenType.TemplateExpression];
        if (stringTypes.indexOf(token.kind) > -1 || token.text && token.kind !== this.tokenType.NumericLiteral)
            return this.formatFnArg(token);
        return null;
    }
    isAsyncFn(token) {
        const isGeneratorFn = !!token.asteriskToken;
        const isAsyncFn = token.modifiers &&
            token.modifiers.some(modifier => modifier.kind === this.tokenType.AsyncKeyword);
        return isGeneratorFn || isAsyncFn;
    }
    getFunctionBody(token) {
        return token.body.statements;
    }
    formatFnData(name, value, token, meta = [{}]) {
        const loc = this.getLocationByOffsets(token.pos, token.end);
        return {
            fnName: name,
            value: value,
            loc: loc.loc,
            start: loc.start,
            end: loc.end,
            meta: lodash_1.merge({}, ...meta)
        };
    }
    analyzeMemberExp(token) {
        let exp = token;
        const tokenType = this.tokenType;
        const callStack = [exp];
        while (exp.kind !== this.tokenType.Identifier) {
            exp = exp.expression || exp.tag;
            callStack.push(exp);
        }
        const meta = this.getMetaInfo(callStack.slice());
        if (exp && this.isApiFn(exp.text)) {
            let parentExp = callStack.pop();
            while (parentExp) {
                if (parentExp.kind === tokenType.CallExpression && parentExp.expression) {
                    const calleeType = parentExp.expression.kind;
                    const calleeMemberFn = calleeType === tokenType.PropertyAccessExpression &&
                        parentExp.expression.name.text;
                    if (this.checkExpDefineTargetName(calleeType, calleeMemberFn))
                        return this.formatFnData(exp.text, this.formatFnArg(parentExp.arguments[0]), token, meta);
                }
                if (parentExp.kind === tokenType.TaggedTemplateExpression && parentExp.tag) {
                    const tagType = parentExp.tag.kind;
                    const tagMemberFn = tagType === tokenType.PropertyAccessExpression && parentExp.tag.name.text;
                    if (this.checkExpDefineTargetName(tagType, tagMemberFn))
                        return this.formatFnData(exp.text, this.formatFnArg(parentExp), token, meta);
                }
                parentExp = callStack.pop();
            }
        }
        return null;
    }
    formatFnArg(arg) {
        if (arg.templateSpans)
            return this.getComputedNameString({ pos: arg.pos, end: arg.end });
        if (arg.head)
            return this.getComputedNameString({ pos: arg.template.pos, end: arg.template.end });
        if (arg.template)
            return arg.template.text || this.getComputedNameString({ pos: arg.template.pos, end: arg.template.end });
        if (arg.kind === this.tokenType.Identifier)
            return this.getComputedNameString({ pos: arg.pos, end: arg.end });
        if (arg.text && arg.kind !== this.tokenType.NumericLiteral)
            return arg.text;
        if (arg.kind === this.tokenType.TypeAssertionExpression)
            return this.formatFnArg(arg.expression);
        return null;
    }
    getFnCall(token) {
        if (this.isApiFn(token.expression.text))
            return this.formatFnData(token.expression.text, this.formatFnArg(token.arguments[0]), token);
        return null;
    }
    getTaggedTemplateExp(token) {
        if (this.isApiFn(token.tag.text))
            return this.formatFnData(token.tag.text, this.formatFnArg(token), token);
        return null;
    }
    analyzeFnCall(token) {
        const tokenType = this.tokenType;
        if (token.kind === tokenType.PropertyAccessExpression)
            return this.analyzeMemberExp(token);
        if (token.kind === tokenType.CallExpression) {
            const expKind = token.expression.kind;
            if (expKind === tokenType.PropertyAccessExpression || expKind === tokenType.CallExpression)
                return this.analyzeMemberExp(token);
            if (expKind === tokenType.ParenthesizedExpression)
                return this.analyzeFnCall(token.expression.expression);
            return this.getFnCall(token);
        }
        if (token.kind === tokenType.FunctionExpression || token.kind === tokenType.ArrowFunction)
            return this.collectTestCafeCalls(this.getFunctionBody(token));
        if (token.kind === tokenType.TaggedTemplateExpression) {
            if (token.tag.kind === tokenType.PropertyAccessExpression || token.tag.kind === tokenType.CallExpression)
                return this.analyzeMemberExp(token);
            return this.getTaggedTemplateExp(token);
        }
        return null;
    }
    parse(code) {
        //NOTE: TypeScript calculates start position of a token incorrectly
        //It doesn't consider spaces and comments between the last token and the current token.
        //So we replace comments with space symbols to calculate fixed position.
        //We just increment position until we meet non whitespace characters
        this.codeArr = code.split('\n');
        this.codeWithoutComments = replaceComments(code);
        const tsConfig = new typescript_configuration_1.default();
        const sourceFile = typescript_1.default.createSourceFile('', code, tsConfig.getOptions(), true);
        return this.analyze(sourceFile.statements);
    }
}
const parser = new TypeScriptTestFileParser();
exports.getTypeScriptTestList = parser.getTestList.bind(parser);
exports.getTypeScriptTestListFromCode = parser.getTestListFromCode.bind(parser);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2V0LXRlc3QtbGlzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3NyYy9jb21waWxlci90ZXN0LWZpbGUvZm9ybWF0cy90eXBlc2NyaXB0L2dldC10ZXN0LWxpc3QuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsNERBQTRCO0FBQzVCLG1DQUF1QztBQUN2Qyx1RUFBaUU7QUFDakUsa0hBQXlGO0FBRXpGLFNBQVMsZUFBZSxDQUFFLElBQUk7SUFDMUIsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLHNDQUFzQyxFQUFFLEtBQUssQ0FBQyxFQUFFO1FBQ2hFLE1BQU0sVUFBVSxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDO1FBRXpELE9BQU8sZUFBTSxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsTUFBTSxHQUFHLFVBQVUsQ0FBQyxDQUFDO0lBQ2xELENBQUMsQ0FBQyxDQUFDO0FBQ1AsQ0FBQztBQUVELE1BQU0sd0JBQXlCLFNBQVEsMENBQWtCO0lBQ3JEO1FBQ0ksS0FBSyxDQUFDLG9CQUFFLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDekIsQ0FBQztJQUVELHFCQUFxQixDQUFFLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRTtRQUMvQixNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsb0JBQW9CLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBRXhELE9BQU8sMENBQWtCLENBQUMsa0JBQWtCLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDN0UsQ0FBQztJQUVELFlBQVksQ0FBRSxLQUFLO1FBQ2YsT0FBTyxLQUFLLENBQUMsSUFBSSxDQUFDO0lBQ3RCLENBQUM7SUFFRCxjQUFjLENBQUUsS0FBSztRQUNqQixPQUFPLEtBQUss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SUFDaEIsQ0FBQztJQUVELEtBQUssQ0FBRSxJQUFJO1FBQ1AsbUVBQW1FO1FBQ25FLHVGQUF1RjtRQUN2Rix3RUFBd0U7UUFDeEUsb0VBQW9FO1FBQ3BFLElBQUksQ0FBQyxPQUFPLEdBQWUsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUM1QyxJQUFJLENBQUMsbUJBQW1CLEdBQUcsZUFBZSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBRWpELE1BQU0sUUFBUSxHQUFLLElBQUksa0NBQXVCLEVBQUUsQ0FBQztRQUNqRCxNQUFNLFVBQVUsR0FBRyxvQkFBRSxDQUFDLGdCQUFnQixDQUFDLEVBQUUsRUFBRSxJQUFJLEVBQUUsUUFBUSxDQUFDLFVBQVUsRUFBRSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBRTlFLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDL0MsQ0FBQztDQUNKO0FBRUQsTUFBTSxNQUFNLEdBQUcsSUFBSSx3QkFBd0IsRUFBRSxDQUFDO0FBRWpDLFFBQUEscUJBQXFCLEdBQVcsTUFBTSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDaEUsUUFBQSw2QkFBNkIsR0FBRyxNQUFNLENBQUMsbUJBQW1CLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHRzIGZyb20gJ3R5cGVzY3JpcHQnO1xuaW1wb3J0IHsgcmVwZWF0LCBtZXJnZSB9IGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBUZXN0RmlsZVBhcnNlckJhc2UgfSBmcm9tICcuLi8uLi90ZXN0LWZpbGUtcGFyc2VyLWJhc2UnO1xuaW1wb3J0IFR5cGVzY3JpcHRDb25maWd1cmF0aW9uIGZyb20gJy4uLy4uLy4uLy4uL2NvbmZpZ3VyYXRpb24vdHlwZXNjcmlwdC1jb25maWd1cmF0aW9uJztcblxuZnVuY3Rpb24gcmVwbGFjZUNvbW1lbnRzIChjb2RlKSB7XG4gICAgcmV0dXJuIGNvZGUucmVwbGFjZSgvXFwvXFwqW1xcc1xcU10qP1xcKlxcL3woW15cXFxcOl18XilcXC9cXC8uKiQvZ20sIG1hdGNoID0+IHtcbiAgICAgICAgY29uc3QgbGFzdFN5bWJvbCA9IG1hdGNoLmluZGV4T2YoJ1xcbicpID4gLTEgPyAnXFxuJyA6ICcgJztcblxuICAgICAgICByZXR1cm4gcmVwZWF0KCcgJywgbWF0Y2gubGVuZ3RoICsgbGFzdFN5bWJvbCk7XG4gICAgfSk7XG59XG5cbmNsYXNzIFR5cGVTY3JpcHRUZXN0RmlsZVBhcnNlciBleHRlbmRzIFRlc3RGaWxlUGFyc2VyQmFzZSB7XG4gICAgY29uc3RydWN0b3IgKCkge1xuICAgICAgICBzdXBlcih0cy5TeW50YXhLaW5kKTtcbiAgICB9XG5cbiAgICBnZXRDb21wdXRlZE5hbWVTdHJpbmcgKHsgcG9zLCBlbmQgfSkge1xuICAgICAgICBjb25zdCB0ZW1wbGF0ZVBvcyA9IHRoaXMuZ2V0TG9jYXRpb25CeU9mZnNldHMocG9zLCBlbmQpO1xuXG4gICAgICAgIHJldHVybiBUZXN0RmlsZVBhcnNlckJhc2UuZm9ybWF0Q29tcHV0ZWROYW1lKHRlbXBsYXRlUG9zLmxvYy5zdGFydC5saW5lKTtcbiAgICB9XG5cbiAgICBnZXRUb2tlblR5cGUgKHRva2VuKSB7XG4gICAgICAgIHJldHVybiB0b2tlbi5raW5kO1xuICAgIH1cblxuICAgIGdldENhbGxlZVRva2VuICh0b2tlbikge1xuICAgICAgICByZXR1cm4gdG9rZW4uZXhwcmVzc2lvbjtcbiAgICB9XG5cbiAgICBnZXRNZW1iZXJGbk5hbWUgKHRva2VuKSB7XG4gICAgICAgIHJldHVybiB0b2tlbi5leHByZXNzaW9uLm5hbWUudGV4dDtcbiAgICB9XG5cbiAgICBnZXRLZXlWYWx1ZSAocHJvcCkge1xuICAgICAgICBjb25zdCB7IG5hbWUsIGluaXRpYWxpemVyIH0gPSBwcm9wO1xuXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBrZXk6ICAgbmFtZS50ZXh0LFxuICAgICAgICAgICAgdmFsdWU6IHRoaXMuZ2V0U3RyaW5nVmFsdWUoaW5pdGlhbGl6ZXIpXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgZ2V0Rml4ZWRTdGFydE9mZnNldCAoc3RhcnQpIHtcbiAgICAgICAgbGV0IGZpeGVkU3RhcnRPZmZzZXQgPSBzdGFydDtcblxuICAgICAgICB3aGlsZSAoL1xccy8udGVzdCh0aGlzLmNvZGVXaXRob3V0Q29tbWVudHNbZml4ZWRTdGFydE9mZnNldF0pKVxuICAgICAgICAgICAgKytmaXhlZFN0YXJ0T2Zmc2V0O1xuXG4gICAgICAgIHJldHVybiBmaXhlZFN0YXJ0T2Zmc2V0O1xuICAgIH1cblxuICAgIGdldExvY2F0aW9uQnlPZmZzZXRzIChzdGFydCwgZW5kKSB7XG4gICAgICAgIGNvbnN0IGZpeGVkU3RhcnQgPSB0aGlzLmdldEZpeGVkU3RhcnRPZmZzZXQoc3RhcnQpO1xuICAgICAgICBjb25zdCBjb2RlQXJyICAgID0gdGhpcy5jb2RlQXJyO1xuICAgICAgICBjb25zdCBsb2MgICAgICAgID0geyBzdGFydDogbnVsbCwgZW5kOiBudWxsIH07XG5cbiAgICAgICAgbGV0IGxpbmUgICAgID0gY29kZUFyclswXTtcbiAgICAgICAgbGV0IHN0YXJ0VG1wID0gZml4ZWRTdGFydDtcbiAgICAgICAgbGV0IGVuZFRtcCAgID0gZW5kO1xuXG4gICAgICAgIGZvciAobGV0IGxpbmVOdW1iZXIgPSAxOyBsaW5lTnVtYmVyIDw9IGNvZGVBcnIubGVuZ3RoOyArK2xpbmVOdW1iZXIsIGxpbmUgPSBjb2RlQXJyW2xpbmVOdW1iZXIgLSAxXSkge1xuICAgICAgICAgICAgc3RhcnRUbXAgLT0gbGluZS5sZW5ndGggKyAxO1xuICAgICAgICAgICAgZW5kVG1wIC09IGxpbmUubGVuZ3RoICsgMTtcblxuICAgICAgICAgICAgaWYgKHN0YXJ0VG1wIDwgMCAmJiAhbG9jLnN0YXJ0KVxuICAgICAgICAgICAgICAgIGxvYy5zdGFydCA9IHsgbGluZTogbGluZU51bWJlciwgY29sdW1uOiBsaW5lLmxlbmd0aCArIHN0YXJ0VG1wICsgMSB9O1xuXG4gICAgICAgICAgICBpZiAoZW5kVG1wIDw9IDAgfHwgbGluZU51bWJlciA9PT0gY29kZUFyci5sZW5ndGggLSAxKSB7XG4gICAgICAgICAgICAgICAgbG9jLmVuZCA9IHsgbGluZTogbGluZU51bWJlciwgY29sdW1uOiBsaW5lLmxlbmd0aCArIGVuZFRtcCArIDEgfTtcblxuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHsgbG9jLCBzdGFydDogZml4ZWRTdGFydCwgZW5kIH07XG4gICAgfVxuXG4gICAgZ2V0UlZhbHVlICh0b2tlbikge1xuICAgICAgICByZXR1cm4gdG9rZW4uZGVjbGFyYXRpb25MaXN0LmRlY2xhcmF0aW9uc1swXS5pbml0aWFsaXplcjtcbiAgICB9XG5cbiAgICBnZXRTdHJpbmdWYWx1ZSAodG9rZW4pIHtcbiAgICAgICAgY29uc3Qgc3RyaW5nVHlwZXMgPSBbdGhpcy50b2tlblR5cGUuU3RyaW5nTGl0ZXJhbCwgdGhpcy50b2tlblR5cGUuVGVtcGxhdGVFeHByZXNzaW9uXTtcblxuICAgICAgICBpZiAoc3RyaW5nVHlwZXMuaW5kZXhPZih0b2tlbi5raW5kKSA+IC0xIHx8IHRva2VuLnRleHQgJiYgdG9rZW4ua2luZCAhPT0gdGhpcy50b2tlblR5cGUuTnVtZXJpY0xpdGVyYWwpXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5mb3JtYXRGbkFyZyh0b2tlbik7XG5cbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgaXNBc3luY0ZuICh0b2tlbikge1xuICAgICAgICBjb25zdCBpc0dlbmVyYXRvckZuID0gISF0b2tlbi5hc3Rlcmlza1Rva2VuO1xuICAgICAgICBjb25zdCBpc0FzeW5jRm4gICAgID0gdG9rZW4ubW9kaWZpZXJzICYmXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b2tlbi5tb2RpZmllcnMuc29tZShtb2RpZmllciA9PiBtb2RpZmllci5raW5kID09PSB0aGlzLnRva2VuVHlwZS5Bc3luY0tleXdvcmQpO1xuXG4gICAgICAgIHJldHVybiBpc0dlbmVyYXRvckZuIHx8IGlzQXN5bmNGbjtcbiAgICB9XG5cbiAgICBnZXRGdW5jdGlvbkJvZHkgKHRva2VuKSB7XG4gICAgICAgIHJldHVybiB0b2tlbi5ib2R5LnN0YXRlbWVudHM7XG4gICAgfVxuXG4gICAgZm9ybWF0Rm5EYXRhIChuYW1lLCB2YWx1ZSwgdG9rZW4sIG1ldGEgPSBbe31dKSB7XG4gICAgICAgIGNvbnN0IGxvYyA9IHRoaXMuZ2V0TG9jYXRpb25CeU9mZnNldHModG9rZW4ucG9zLCB0b2tlbi5lbmQpO1xuXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBmbk5hbWU6IG5hbWUsXG4gICAgICAgICAgICB2YWx1ZTogIHZhbHVlLFxuICAgICAgICAgICAgbG9jOiAgICBsb2MubG9jLFxuICAgICAgICAgICAgc3RhcnQ6ICBsb2Muc3RhcnQsXG4gICAgICAgICAgICBlbmQ6ICAgIGxvYy5lbmQsXG4gICAgICAgICAgICBtZXRhOiAgIG1lcmdlKHt9LCAuLi5tZXRhKVxuICAgICAgICB9O1xuICAgIH1cblxuICAgIGFuYWx5emVNZW1iZXJFeHAgKHRva2VuKSB7XG4gICAgICAgIGxldCBleHAgICAgICAgICA9IHRva2VuO1xuICAgICAgICBjb25zdCB0b2tlblR5cGUgPSB0aGlzLnRva2VuVHlwZTtcbiAgICAgICAgY29uc3QgY2FsbFN0YWNrID0gW2V4cF07XG5cbiAgICAgICAgd2hpbGUgKGV4cC5raW5kICE9PSB0aGlzLnRva2VuVHlwZS5JZGVudGlmaWVyKSB7XG4gICAgICAgICAgICBleHAgPSBleHAuZXhwcmVzc2lvbiB8fCBleHAudGFnO1xuXG4gICAgICAgICAgICBjYWxsU3RhY2sucHVzaChleHApO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgbWV0YSA9IHRoaXMuZ2V0TWV0YUluZm8oY2FsbFN0YWNrLnNsaWNlKCkpO1xuXG4gICAgICAgIGlmIChleHAgJiYgdGhpcy5pc0FwaUZuKGV4cC50ZXh0KSkge1xuICAgICAgICAgICAgbGV0IHBhcmVudEV4cCA9IGNhbGxTdGFjay5wb3AoKTtcblxuICAgICAgICAgICAgd2hpbGUgKHBhcmVudEV4cCkge1xuICAgICAgICAgICAgICAgIGlmIChwYXJlbnRFeHAua2luZCA9PT0gdG9rZW5UeXBlLkNhbGxFeHByZXNzaW9uICYmIHBhcmVudEV4cC5leHByZXNzaW9uKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGNhbGxlZVR5cGUgICAgID0gcGFyZW50RXhwLmV4cHJlc3Npb24ua2luZDtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgY2FsbGVlTWVtYmVyRm4gPSBjYWxsZWVUeXBlID09PSB0b2tlblR5cGUuUHJvcGVydHlBY2Nlc3NFeHByZXNzaW9uICYmXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50RXhwLmV4cHJlc3Npb24ubmFtZS50ZXh0O1xuXG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmNoZWNrRXhwRGVmaW5lVGFyZ2V0TmFtZShjYWxsZWVUeXBlLCBjYWxsZWVNZW1iZXJGbikpXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5mb3JtYXRGbkRhdGEoZXhwLnRleHQsIHRoaXMuZm9ybWF0Rm5BcmcocGFyZW50RXhwLmFyZ3VtZW50c1swXSksIHRva2VuLCBtZXRhKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAocGFyZW50RXhwLmtpbmQgPT09IHRva2VuVHlwZS5UYWdnZWRUZW1wbGF0ZUV4cHJlc3Npb24gJiYgcGFyZW50RXhwLnRhZykge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCB0YWdUeXBlICAgICA9IHBhcmVudEV4cC50YWcua2luZDtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdGFnTWVtYmVyRm4gPSB0YWdUeXBlID09PSB0b2tlblR5cGUuUHJvcGVydHlBY2Nlc3NFeHByZXNzaW9uICYmIHBhcmVudEV4cC50YWcubmFtZS50ZXh0O1xuXG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmNoZWNrRXhwRGVmaW5lVGFyZ2V0TmFtZSh0YWdUeXBlLCB0YWdNZW1iZXJGbikpXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5mb3JtYXRGbkRhdGEoZXhwLnRleHQsIHRoaXMuZm9ybWF0Rm5BcmcocGFyZW50RXhwKSwgdG9rZW4sIG1ldGEpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHBhcmVudEV4cCA9IGNhbGxTdGFjay5wb3AoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIGZvcm1hdEZuQXJnIChhcmcpIHtcbiAgICAgICAgaWYgKGFyZy50ZW1wbGF0ZVNwYW5zKVxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0Q29tcHV0ZWROYW1lU3RyaW5nKHsgcG9zOiBhcmcucG9zLCBlbmQ6IGFyZy5lbmQgfSk7XG5cbiAgICAgICAgaWYgKGFyZy5oZWFkKVxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0Q29tcHV0ZWROYW1lU3RyaW5nKHsgcG9zOiBhcmcudGVtcGxhdGUucG9zLCBlbmQ6IGFyZy50ZW1wbGF0ZS5lbmQgfSk7XG5cbiAgICAgICAgaWYgKGFyZy50ZW1wbGF0ZSlcbiAgICAgICAgICAgIHJldHVybiBhcmcudGVtcGxhdGUudGV4dCB8fCB0aGlzLmdldENvbXB1dGVkTmFtZVN0cmluZyh7IHBvczogYXJnLnRlbXBsYXRlLnBvcywgZW5kOiBhcmcudGVtcGxhdGUuZW5kIH0pO1xuXG4gICAgICAgIGlmIChhcmcua2luZCA9PT0gdGhpcy50b2tlblR5cGUuSWRlbnRpZmllcilcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmdldENvbXB1dGVkTmFtZVN0cmluZyh7IHBvczogYXJnLnBvcywgZW5kOiBhcmcuZW5kIH0pO1xuXG4gICAgICAgIGlmIChhcmcudGV4dCAmJiBhcmcua2luZCAhPT0gdGhpcy50b2tlblR5cGUuTnVtZXJpY0xpdGVyYWwpXG4gICAgICAgICAgICByZXR1cm4gYXJnLnRleHQ7XG5cbiAgICAgICAgaWYgKGFyZy5raW5kID09PSB0aGlzLnRva2VuVHlwZS5UeXBlQXNzZXJ0aW9uRXhwcmVzc2lvbilcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmZvcm1hdEZuQXJnKGFyZy5leHByZXNzaW9uKTtcblxuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICBnZXRGbkNhbGwgKHRva2VuKSB7XG4gICAgICAgIGlmICh0aGlzLmlzQXBpRm4odG9rZW4uZXhwcmVzc2lvbi50ZXh0KSlcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmZvcm1hdEZuRGF0YSh0b2tlbi5leHByZXNzaW9uLnRleHQsIHRoaXMuZm9ybWF0Rm5BcmcodG9rZW4uYXJndW1lbnRzWzBdKSwgdG9rZW4pO1xuXG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIGdldFRhZ2dlZFRlbXBsYXRlRXhwICh0b2tlbikge1xuICAgICAgICBpZiAodGhpcy5pc0FwaUZuKHRva2VuLnRhZy50ZXh0KSlcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmZvcm1hdEZuRGF0YSh0b2tlbi50YWcudGV4dCwgdGhpcy5mb3JtYXRGbkFyZyh0b2tlbiksIHRva2VuKTtcblxuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICBhbmFseXplRm5DYWxsICh0b2tlbikge1xuICAgICAgICBjb25zdCB0b2tlblR5cGUgPSB0aGlzLnRva2VuVHlwZTtcblxuICAgICAgICBpZiAodG9rZW4ua2luZCA9PT0gdG9rZW5UeXBlLlByb3BlcnR5QWNjZXNzRXhwcmVzc2lvbilcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmFuYWx5emVNZW1iZXJFeHAodG9rZW4pO1xuXG4gICAgICAgIGlmICh0b2tlbi5raW5kID09PSB0b2tlblR5cGUuQ2FsbEV4cHJlc3Npb24pIHtcbiAgICAgICAgICAgIGNvbnN0IGV4cEtpbmQgPSB0b2tlbi5leHByZXNzaW9uLmtpbmQ7XG5cbiAgICAgICAgICAgIGlmIChleHBLaW5kID09PSB0b2tlblR5cGUuUHJvcGVydHlBY2Nlc3NFeHByZXNzaW9uIHx8IGV4cEtpbmQgPT09IHRva2VuVHlwZS5DYWxsRXhwcmVzc2lvbilcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5hbmFseXplTWVtYmVyRXhwKHRva2VuKTtcblxuICAgICAgICAgICAgaWYgKGV4cEtpbmQgPT09IHRva2VuVHlwZS5QYXJlbnRoZXNpemVkRXhwcmVzc2lvbilcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5hbmFseXplRm5DYWxsKHRva2VuLmV4cHJlc3Npb24uZXhwcmVzc2lvbik7XG5cbiAgICAgICAgICAgIHJldHVybiB0aGlzLmdldEZuQ2FsbCh0b2tlbik7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodG9rZW4ua2luZCA9PT0gdG9rZW5UeXBlLkZ1bmN0aW9uRXhwcmVzc2lvbiB8fCB0b2tlbi5raW5kID09PSB0b2tlblR5cGUuQXJyb3dGdW5jdGlvbilcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmNvbGxlY3RUZXN0Q2FmZUNhbGxzKHRoaXMuZ2V0RnVuY3Rpb25Cb2R5KHRva2VuKSk7XG5cbiAgICAgICAgaWYgKHRva2VuLmtpbmQgPT09IHRva2VuVHlwZS5UYWdnZWRUZW1wbGF0ZUV4cHJlc3Npb24pIHtcbiAgICAgICAgICAgIGlmICh0b2tlbi50YWcua2luZCA9PT0gdG9rZW5UeXBlLlByb3BlcnR5QWNjZXNzRXhwcmVzc2lvbiB8fCB0b2tlbi50YWcua2luZCA9PT0gdG9rZW5UeXBlLkNhbGxFeHByZXNzaW9uKVxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmFuYWx5emVNZW1iZXJFeHAodG9rZW4pO1xuXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRUYWdnZWRUZW1wbGF0ZUV4cCh0b2tlbik7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICBwYXJzZSAoY29kZSkge1xuICAgICAgICAvL05PVEU6IFR5cGVTY3JpcHQgY2FsY3VsYXRlcyBzdGFydCBwb3NpdGlvbiBvZiBhIHRva2VuIGluY29ycmVjdGx5XG4gICAgICAgIC8vSXQgZG9lc24ndCBjb25zaWRlciBzcGFjZXMgYW5kIGNvbW1lbnRzIGJldHdlZW4gdGhlIGxhc3QgdG9rZW4gYW5kIHRoZSBjdXJyZW50IHRva2VuLlxuICAgICAgICAvL1NvIHdlIHJlcGxhY2UgY29tbWVudHMgd2l0aCBzcGFjZSBzeW1ib2xzIHRvIGNhbGN1bGF0ZSBmaXhlZCBwb3NpdGlvbi5cbiAgICAgICAgLy9XZSBqdXN0IGluY3JlbWVudCBwb3NpdGlvbiB1bnRpbCB3ZSBtZWV0IG5vbiB3aGl0ZXNwYWNlIGNoYXJhY3RlcnNcbiAgICAgICAgdGhpcy5jb2RlQXJyICAgICAgICAgICAgID0gY29kZS5zcGxpdCgnXFxuJyk7XG4gICAgICAgIHRoaXMuY29kZVdpdGhvdXRDb21tZW50cyA9IHJlcGxhY2VDb21tZW50cyhjb2RlKTtcblxuICAgICAgICBjb25zdCB0c0NvbmZpZyAgID0gbmV3IFR5cGVzY3JpcHRDb25maWd1cmF0aW9uKCk7XG4gICAgICAgIGNvbnN0IHNvdXJjZUZpbGUgPSB0cy5jcmVhdGVTb3VyY2VGaWxlKCcnLCBjb2RlLCB0c0NvbmZpZy5nZXRPcHRpb25zKCksIHRydWUpO1xuXG4gICAgICAgIHJldHVybiB0aGlzLmFuYWx5emUoc291cmNlRmlsZS5zdGF0ZW1lbnRzKTtcbiAgICB9XG59XG5cbmNvbnN0IHBhcnNlciA9IG5ldyBUeXBlU2NyaXB0VGVzdEZpbGVQYXJzZXIoKTtcblxuZXhwb3J0IGNvbnN0IGdldFR5cGVTY3JpcHRUZXN0TGlzdCAgICAgICAgID0gcGFyc2VyLmdldFRlc3RMaXN0LmJpbmQocGFyc2VyKTtcbmV4cG9ydCBjb25zdCBnZXRUeXBlU2NyaXB0VGVzdExpc3RGcm9tQ29kZSA9IHBhcnNlci5nZXRUZXN0TGlzdEZyb21Db2RlLmJpbmQocGFyc2VyKTtcbiJdfQ==