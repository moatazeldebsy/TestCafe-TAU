"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const os_family_1 = __importDefault(require("os-family"));
const which_promise_1 = __importDefault(require("which-promise"));
const lodash_1 = require("lodash");
const fs_exists_promised_1 = __importDefault(require("../utils/fs-exists-promised"));
const exec_1 = require("../utils/exec");
const find_alias_1 = __importDefault(require("../utils/find-alias"));
const unquote_1 = __importDefault(require("../utils/unquote"));
const aliases_1 = __importDefault(require("../aliases"));
const MICROSOFT_EDGE_CLASS = 'Microsoft.MicrosoftEdge';
const MICROSOFT_EDGE_KEY_GLOB = `HKCU\\Software\\Classes\\ActivatableClasses\\Package\\${MICROSOFT_EDGE_CLASS}*`;
const BROWSER_COMMANDS_KEY_GLOB = root => `${root}\\Software\\Clients\\StartMenuInternet\\*\\shell\\open\\command`;
const MACOS_GET_BROWSER_LIST_COMMAND = 'ls "/Applications/" | grep -E "Chrome|Firefox|Opera|Safari|Chromium|Edge" | sed -E "s/ /032/"';
const LINE_WRAP = '\r\n';
const DOUBLE_LINE_WRAP = LINE_WRAP + LINE_WRAP;
const REGISTRY_BROWSER_PATH_PROPERTY = '(default)';
const REGISTRY_BROWSER_NAME_PROPERTY = 'PSPath';
const REGISTRY_PROPERTIES_RE = /^(\(default\)|PSPath)\s*:\s*(.+)$/;
const MAX_OUTPUT_WIDTH = 2 ** 31 - 1;
const POWERSHELL_PIPE_SYMBOL = '|';
const GET_REGISTRY_KEY_COMMAND = key => `Get-Item 'Registry::${key}'`;
const GET_BROWSER_PATH_PROPERTY_COMMAND = `Get-ItemProperty -Name '${REGISTRY_BROWSER_PATH_PROPERTY}'`;
const FORMAT_BROWSER_INFO_COMMAND = `Format-List -Property '${REGISTRY_BROWSER_PATH_PROPERTY}','${REGISTRY_BROWSER_NAME_PROPERTY}'`;
const LIMIT_OUTPUT_WIDTH_COMMAND = `Out-String -Width ${MAX_OUTPUT_WIDTH}`;
// NOTE: We have to use Write-Host for compatibility with PowerShell 2.0
const WRITE_HOST_COMMAND = 'Write-Host';
const GET_REGISTRY_BROWSER_PROPERTIES_COMMAND = key => [
    GET_REGISTRY_KEY_COMMAND(key),
    GET_BROWSER_PATH_PROPERTY_COMMAND,
    FORMAT_BROWSER_INFO_COMMAND,
    LIMIT_OUTPUT_WIDTH_COMMAND,
    WRITE_HOST_COMMAND
].join(POWERSHELL_PIPE_SYMBOL);
// Installation info cache
var installationsCache = null;
async function getRegistryKey(regKeyGlob) {
    return exec_1.execPowershell(GET_REGISTRY_KEY_COMMAND(regKeyGlob));
}
async function getRegistryBrowserProperties(regKeyGlob) {
    return exec_1.execPowershell(GET_REGISTRY_BROWSER_PROPERTIES_COMMAND(regKeyGlob));
}
// Find installations for different platforms
async function addInstallation(installations, key, instPath) {
    if (!await fs_exists_promised_1.default(instPath))
        return;
    const detectedAlias = find_alias_1.default(key);
    if (!detectedAlias)
        return;
    const { name, alias: { cmd, macOpenCmdTemplate, path } } = detectedAlias;
    installations[name] = { path: path || instPath, cmd, macOpenCmdTemplate };
}
async function detectMicrosoftEdgeLegacy() {
    const registryResult = await getRegistryKey(MICROSOFT_EDGE_KEY_GLOB);
    if (registryResult.stdout.includes(MICROSOFT_EDGE_CLASS))
        return aliases_1.default['edge-legacy'];
    return null;
}
async function searchInRegistry(registryRoot) {
    const installations = {};
    const registryResult = await getRegistryBrowserProperties(BROWSER_COMMANDS_KEY_GLOB(registryRoot));
    const data = registryResult.stdout
        .split(DOUBLE_LINE_WRAP)
        .map(block => block
        .split(LINE_WRAP)
        .map(line => line.match(REGISTRY_PROPERTIES_RE))
        .filter(match => !!match)
        .map(match => ({
        [match[1]]: unquote_1.default(match[2])
    })))
        .filter(block => block && block.length)
        .map(block => lodash_1.merge(...block));
    await Promise.all(data.map(record => addInstallation(installations, record[REGISTRY_BROWSER_NAME_PROPERTY], record[REGISTRY_BROWSER_PATH_PROPERTY])));
    return installations;
}
async function findWindowsBrowsers() {
    const machineRegisteredBrowsers = await searchInRegistry('HKEY_LOCAL_MACHINE');
    const userRegisteredBrowsers = await searchInRegistry('HKEY_CURRENT_USER');
    const installations = Object.assign(machineRegisteredBrowsers, userRegisteredBrowsers);
    const edgeLegacy = await detectMicrosoftEdgeLegacy();
    if (edgeLegacy)
        installations['edge-legacy'] = edgeLegacy;
    if (edgeLegacy && !installations['edge'])
        installations['edge'] = edgeLegacy;
    return installations;
}
async function findMacBrowsers() {
    var installations = {};
    // NOTE: replace the space symbol with code, because grep splits strings by space.
    var stdout = await exec_1.exec(MACOS_GET_BROWSER_LIST_COMMAND);
    await Promise.all(stdout
        .split('\n')
        .filter(fileName => !!fileName)
        .map(fileName => {
        // NOTE: restore space
        fileName = fileName.replace(/032/g, ' ');
        var name = fileName.replace(/.app$/, '');
        var path = `/Applications/${fileName}`;
        return addInstallation(installations, name, path);
    }));
    return installations;
}
async function findLinuxBrowsers() {
    var installations = {};
    var aliasCheckingPromises = Object
        .keys(aliases_1.default)
        .map(name => {
        var { linuxBinaries } = aliases_1.default[name];
        if (!linuxBinaries)
            return null;
        var detectionPromises = linuxBinaries
            .map(binary => {
            return which_promise_1.default(binary)
                .then(path => addInstallation(installations, name, path))
                .catch(() => {
                // NOTE: binary not found, just do nothing
                return;
            });
        });
        return Promise.all(detectionPromises);
    });
    await Promise.all(aliasCheckingPromises);
    return installations;
}
async function findBrowsers() {
    if (os_family_1.default.win)
        return await findWindowsBrowsers();
    if (os_family_1.default.mac)
        return await findMacBrowsers();
    if (os_family_1.default.linux)
        return await findLinuxBrowsers();
    return {};
}
// API
/** @typedef {Object} BrowserInfo
 * @description Object that contains information about the browser installed on the machine.
 * @property {string|undefined} path - The path to the executable file that starts the browser.
 *  Required on MacOS machines. On Windows machines, it is used when the winOpenCmdTemplate property is undefined.
 * @property {string} cmd - Additional command line parameters.
 * @property {string} macOpenCmdTemplate - A [Mustache template](https://github.com/janl/mustache.js#templates)
 *  that provides parameters for launching the browser on a MacOS machine.
 * @property {string|undefined} winOpenCmdTemplate - A [Mustache template](https://github.com/janl/mustache.js#templates)
 *  that provides parameters for launching the browser on a Windows machine.  If undefined, the path to the
 *  executable file specified by the path property is used.
 * @example
 *  {
 *       path: 'C:\\ProgramFiles\\...\\firefox.exe',
 *       cmd: '-new-window',
 *       macOpenCmdTemplate: 'open -a "{{{path}}}" {{{pageUrl}}} --args {{{cmd}}}'
 *  }
 */
/**
 * Returns the list of the {@link BrowserInfo} objects that contain information about the browsers installed on the machine.
 * @function
 * @async
 * @name getInstallations
 * @returns {Object.<string, BrowserInfo>} List of the {@link BrowserInfo} objects
 *   containing information about the browsers installed on the machine.
 * @example
 * {
 *   chrome: {
 *       path: 'C:\\ProgramFiles\\...\\chrome.exe',
 *       cmd: '--new-window',
 *       macOpenCmdTemplate: 'open -n -a "{{{path}}}" --args {{{pageUrl}}} {{{cmd}}}'
 *   },
 *
 *   firefox: {
 *       path: 'C:\\ProgramFiles\\...\\firefox.exe',
 *       cmd: '-new-window',
 *       macOpenCmdTemplate: 'open -a "{{{path}}}" {{{pageUrl}}} --args {{{cmd}}}'
 *   }
 * }
 */
async function default_1() {
    if (!installationsCache)
        installationsCache = await findBrowsers();
    return installationsCache;
}
exports.default = default_1;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2V0LWluc3RhbGxhdGlvbnMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvYXBpL2dldC1pbnN0YWxsYXRpb25zLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsMERBQTJCO0FBQzNCLGtFQUFrQztBQUNsQyxtQ0FBK0I7QUFDL0IscUZBQWlEO0FBQ2pELHdDQUFxRDtBQUNyRCxxRUFBNEM7QUFDNUMsK0RBQXVDO0FBQ3ZDLHlEQUFpQztBQUVqQyxNQUFNLG9CQUFvQixHQUFRLHlCQUF5QixDQUFDO0FBQzVELE1BQU0sdUJBQXVCLEdBQUsseURBQXlELG9CQUFvQixHQUFHLENBQUM7QUFDbkgsTUFBTSx5QkFBeUIsR0FBRyxJQUFJLENBQUMsRUFBRSxDQUFDLEdBQUcsSUFBSSxpRUFBaUUsQ0FBQztBQUVuSCxNQUFNLDhCQUE4QixHQUFHLCtGQUErRixDQUFDO0FBRXZJLE1BQU0sU0FBUyxHQUFVLE1BQU0sQ0FBQztBQUNoQyxNQUFNLGdCQUFnQixHQUFHLFNBQVMsR0FBRyxTQUFTLENBQUM7QUFFL0MsTUFBTSw4QkFBOEIsR0FBRyxXQUFXLENBQUM7QUFDbkQsTUFBTSw4QkFBOEIsR0FBRyxRQUFRLENBQUM7QUFDaEQsTUFBTSxzQkFBc0IsR0FBVyxtQ0FBbUMsQ0FBQztBQUUzRSxNQUFNLGdCQUFnQixHQUFHLENBQUMsSUFBSSxFQUFFLEdBQUcsQ0FBQyxDQUFDO0FBRXJDLE1BQU0sc0JBQXNCLEdBQUcsR0FBRyxDQUFDO0FBRW5DLE1BQU0sd0JBQXdCLEdBQVksR0FBRyxDQUFDLEVBQUUsQ0FBQyx1QkFBdUIsR0FBRyxHQUFHLENBQUM7QUFDL0UsTUFBTSxpQ0FBaUMsR0FBRywyQkFBMkIsOEJBQThCLEdBQUcsQ0FBQztBQUN2RyxNQUFNLDJCQUEyQixHQUFTLDBCQUEwQiw4QkFBOEIsTUFBTSw4QkFBOEIsR0FBRyxDQUFDO0FBQzFJLE1BQU0sMEJBQTBCLEdBQVUscUJBQXFCLGdCQUFnQixFQUFFLENBQUM7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QUV2QyxJQUFJLG1CQUFFLENBQUMsR0FBRztRQUNOLE9BQU8sTUFBTSxlQUFlLEVBQUUsQ0FBQztJQUVuQyxJQUFJLG1CQUFFLENBQUMsS0FBSztRQUNSLE9BQU8sTUFBTSxpQkFBaUIsRUFBRSxDQUFDO0lBRXJDLE9BQU8sRUFBRSxDQUFDO0FBQ2QsQ0FBQztBQUdELE1BQU07QUFDTjs7Ozs7Ozs7Ozs7Ozs7OztHQWdCRztBQUVIOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7R0FxQkc7QUFDWSxLQUFLO0lBQ2hCLElBQUksQ0FBQyxrQkFBa0I7UUFDbkIsa0JBQWtCLEdBQUcsTUFBTSxZQUFZLEVBQUUsQ0FBQztJQUU5QyxPQUFPLGtCQUFrQixDQUFDO0FBQzlCLENBQUM7QUFMRCw0QkFLQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBPUyBmcm9tICdvcy1mYW1pbHknO1xuaW1wb3J0IHdoaWNoIGZyb20gJ3doaWNoLXByb21pc2UnO1xuaW1wb3J0IHsgbWVyZ2UgfSBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IGV4aXN0cyBmcm9tICcuLi91dGlscy9mcy1leGlzdHMtcHJvbWlzZWQnO1xuaW1wb3J0IHsgZXhlYywgZXhlY1Bvd2Vyc2hlbGwgfSBmcm9tICcuLi91dGlscy9leGVjJztcbmltcG9ydCBmaW5kQWxpYXMgZnJvbSAnLi4vdXRpbHMvZmluZC1hbGlhcyc7XG5pbXBvcnQgdW5xdW90ZSBmcm9tICcuLi91dGlscy91bnF1b3RlJztcbmltcG9ydCBBTElBU0VTIGZyb20gJy4uL2FsaWFzZXMnO1xuXG5jb25zdCBNSUNST1NPRlRfRURHRV9DTEFTUyAgICAgID0gJ01pY3Jvc29mdC5NaWNyb3NvZnRFZGdlJztcbmNvbnN0IE1JQ1JPU09GVF9FREdFX0tFWV9HTE9CICAgPSBgSEtDVVxcXFxTb2Z0d2FyZVxcXFxDbGFzc2VzXFxcXEFjdGl2YXRhYmxlQ2xhc3Nlc1xcXFxQYWNrYWdlXFxcXCR7TUlDUk9TT0ZUX0VER0VfQ0xBU1N9KmA7XG5jb25zdCBCUk9XU0VSX0NPTU1BTkRTX0tFWV9HTE9CID0gcm9vdCA9PiBgJHtyb290fVxcXFxTb2Z0d2FyZVxcXFxDbGllbnRzXFxcXFN0YXJ0TWVudUludGVybmV0XFxcXCpcXFxcc2hlbGxcXFxcb3BlblxcXFxjb21tYW5kYDtcblxuY29uc3QgTUFDT1NfR0VUX0JST1dTRVJfTElTVF9DT01NQU5EID0gJ2xzIFwiL0FwcGxpY2F0aW9ucy9cIiB8IGdyZXAgLUUgXCJDaHJvbWV8RmlyZWZveHxPcGVyYXxTYWZhcml8Q2hyb21pdW18RWRnZVwiIHwgc2VkIC1FIFwicy8gLzAzMi9cIic7XG5cbmNvbnN0IExJTkVfV1JBUCAgICAgICAgPSAnXFxyXFxuJztcbmNvbnN0IERPVUJMRV9MSU5FX1dSQVAgPSBMSU5FX1dSQVAgKyBMSU5FX1dSQVA7XG5cbmNvbnN0IFJFR0lTVFJZX0JST1dTRVJfUEFUSF9QUk9QRVJUWSA9ICcoZGVmYXVsdCknO1xuY29uc3QgUkVHSVNUUllfQlJPV1NFUl9OQU1FX1BST1BFUlRZID0gJ1BTUGF0aCc7XG5jb25zdCBSRUdJU1RSWV9QUk9QRVJUSUVTX1JFICAgICAgICAgPSAvXihcXChkZWZhdWx0XFwpfFBTUGF0aClcXHMqOlxccyooLispJC87XG5cbmNvbnN0IE1BWF9PVVRQVVRfV0lEVEggPSAyICoqIDMxIC0gMTtcblxuY29uc3QgUE9XRVJTSEVMTF9QSVBFX1NZTUJPTCA9ICd8JztcblxuY29uc3QgR0VUX1JFR0lTVFJZX0tFWV9DT01NQU5EICAgICAgICAgID0ga2V5ID0+IGBHZXQtSXRlbSAnUmVnaXN0cnk6OiR7a2V5fSdgO1xuY29uc3QgR0VUX0JST1dTRVJfUEFUSF9QUk9QRVJUWV9DT01NQU5EID0gYEdldC1JdGVtUHJvcGVydHkgLU5hbWUgJyR7UkVHSVNUUllfQlJPV1NFUl9QQVRIX1BST1BFUlRZfSdgO1xuY29uc3QgRk9STUFUX0JST1dTRVJfSU5GT19DT01NQU5EICAgICAgID0gYEZvcm1hdC1MaXN0IC1Qcm9wZXJ0eSAnJHtSRUdJU1RSWV9CUk9XU0VSX1BBVEhfUFJPUEVSVFl9JywnJHtSRUdJU1RSWV9CUk9XU0VSX05BTUVfUFJPUEVSVFl9J2A7XG5jb25zdCBMSU1JVF9PVVRQVVRfV0lEVEhfQ09NTUFORCAgICAgICAgPSBgT3V0LVN0cmluZyAtV2lkdGggJHtNQVhfT1VUUFVUX1dJRFRIfWA7XG5cbi8vIE5PVEU6IFdlIGhhdmUgdG8gdXNlIFdyaXRlLUhvc3QgZm9yIGNvbXBhdGliaWxpdHkgd2l0aCBQb3dlclNoZWxsIDIuMFxuY29uc3QgV1JJVEVfSE9TVF9DT01NQU5EID0gJ1dyaXRlLUhvc3QnO1xuXG5jb25zdCBHRVRfUkVHSVNUUllfQlJPV1NFUl9QUk9QRVJUSUVTX0NPTU1BTkQgPSBrZXkgPT4gW1xuICAgIEdFVF9SRUdJU1RSWV9LRVlfQ09NTUFORChrZXkpLFxuICAgIEdFVF9CUk9XU0VSX1BBVEhfUFJPUEVSVFlfQ09NTUFORCxcbiAgICBGT1JNQVRfQlJPV1NFUl9JTkZPX0NPTU1BTkQsXG4gICAgTElNSVRfT1VUUFVUX1dJRFRIX0NPTU1BTkQsXG4gICAgV1JJVEVfSE9TVF9DT01NQU5EXG5dLmpvaW4oUE9XRVJTSEVMTF9QSVBFX1NZTUJPTCk7XG5cbi8vIEluc3RhbGxhdGlvbiBpbmZvIGNhY2hlXG52YXIgaW5zdGFsbGF0aW9uc0NhY2hlID0gbnVsbDtcblxuYXN5bmMgZnVuY3Rpb24gZ2V0UmVnaXN0cnlLZXkgKHJlZ0tleUdsb2IpIHtcbiAgICByZXR1cm4gZXhlY1Bvd2Vyc2hlbGwoR0VUX1JFR0lTVFJZX0tFWV9DT01NQU5EKHJlZ0tleUdsb2IpKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0UmVnaXN0cnlCcm93c2VyUHJvcGVydGllcyAocmVnS2V5R2xvYikge1xuICAgIHJldHVybiBleGVjUG93ZXJzaGVsbChHRVRfUkVHSVNUUllfQlJPV1NFUl9QUk9QRVJUSUVTX0NPTU1BTkQocmVnS2V5R2xvYikpO1xufVxuXG4vLyBGaW5kIGluc3RhbGxhdGlvbnMgZm9yIGRpZmZlcmVudCBwbGF0Zm9ybXNcbmFzeW5jIGZ1bmN0aW9uIGFkZEluc3RhbGxhdGlvbiAoaW5zdGFsbGF0aW9ucywga2V5LCBpbnN0UGF0aCkge1xuICAgIGlmICghYXdhaXQgZXhpc3RzKGluc3RQYXRoKSlcbiAgICAgICAgcmV0dXJuO1xuXG4gICAgY29uc3QgZGV0ZWN0ZWRBbGlhcyA9IGZpbmRBbGlhcyhrZXkpO1xuXG4gICAgaWYgKCFkZXRlY3RlZEFsaWFzKVxuICAgICAgICByZXR1cm47XG5cbiAgICBjb25zdCB7IG5hbWUsIGFsaWFzOiB7IGNtZCwgbWFjT3BlbkNtZFRlbXBsYXRlLCBwYXRoIH0gfSAgPSBkZXRlY3RlZEFsaWFzO1xuXG4gICAgaW5zdGFsbGF0aW9uc1tuYW1lXSA9IHsgcGF0aDogcGF0aCB8fCBpbnN0UGF0aCwgY21kLCBtYWNPcGVuQ21kVGVtcGxhdGUgfTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZGV0ZWN0TWljcm9zb2Z0RWRnZUxlZ2FjeSAoKSB7XG4gICAgY29uc3QgcmVnaXN0cnlSZXN1bHQgPSBhd2FpdCBnZXRSZWdpc3RyeUtleShNSUNST1NPRlRfRURHRV9LRVlfR0xPQik7XG5cbiAgICBpZiAocmVnaXN0cnlSZXN1bHQuc3Rkb3V0LmluY2x1ZGVzKE1JQ1JPU09GVF9FREdFX0NMQVNTKSlcbiAgICAgICAgcmV0dXJuIEFMSUFTRVNbJ2VkZ2UtbGVnYWN5J107XG5cbiAgICByZXR1cm4gbnVsbDtcbn1cblxuYXN5bmMgZnVuY3Rpb24gc2VhcmNoSW5SZWdpc3RyeSAocmVnaXN0cnlSb290KSB7XG4gICAgY29uc3QgaW5zdGFsbGF0aW9ucyAgPSB7fTtcbiAgICBjb25zdCByZWdpc3RyeVJlc3VsdCA9ICBhd2FpdCBnZXRSZWdpc3RyeUJyb3dzZXJQcm9wZXJ0aWVzKEJST1dTRVJfQ09NTUFORFNfS0VZX0dMT0IocmVnaXN0cnlSb290KSk7XG5cbiAgICBjb25zdCBkYXRhID0gcmVnaXN0cnlSZXN1bHQuc3Rkb3V0XG4gICAgICAgIC5zcGxpdChET1VCTEVfTElORV9XUkFQKVxuICAgICAgICAubWFwKGJsb2NrID0+IGJsb2NrXG4gICAgICAgICAgICAuc3BsaXQoTElORV9XUkFQKVxuICAgICAgICAgICAgLm1hcChsaW5lID0+IGxpbmUubWF0Y2goUkVHSVNUUllfUFJPUEVSVElFU19SRSkpXG4gICAgICAgICAgICAuZmlsdGVyKG1hdGNoID0+ICEhbWF0Y2gpXG4gICAgICAgICAgICAubWFwKG1hdGNoID0+ICh7XG4gICAgICAgICAgICAgICAgW21hdGNoWzFdXTogdW5xdW90ZShtYXRjaFsyXSlcbiAgICAgICAgICAgIH0pKVxuICAgICAgICApXG4gICAgICAgIC5maWx0ZXIoYmxvY2sgPT4gYmxvY2sgJiYgYmxvY2subGVuZ3RoKVxuICAgICAgICAubWFwKGJsb2NrID0+IG1lcmdlKC4uLmJsb2NrKSk7XG5cbiAgICBhd2FpdCBQcm9taXNlLmFsbChkYXRhLm1hcChyZWNvcmQgPT4gYWRkSW5zdGFsbGF0aW9uKGluc3RhbGxhdGlvbnMsIHJlY29yZFtSRUdJU1RSWV9CUk9XU0VSX05BTUVfUFJPUEVSVFldLCByZWNvcmRbUkVHSVNUUllfQlJPV1NFUl9QQVRIX1BST1BFUlRZXSkpKTtcblxuICAgIHJldHVybiBpbnN0YWxsYXRpb25zO1xufVxuXG5hc3luYyBmdW5jdGlvbiBmaW5kV2luZG93c0Jyb3dzZXJzICgpIHtcbiAgICBjb25zdCBtYWNoaW5lUmVnaXN0ZXJlZEJyb3dzZXJzID0gYXdhaXQgc2VhcmNoSW5SZWdpc3RyeSgnSEtFWV9MT0NBTF9NQUNISU5FJyk7XG4gICAgY29uc3QgdXNlclJlZ2lzdGVyZWRCcm93c2VycyAgICA9IGF3YWl0IHNlYXJjaEluUmVnaXN0cnkoJ0hLRVlfQ1VSUkVOVF9VU0VSJyk7XG4gICAgY29uc3QgaW5zdGFsbGF0aW9ucyAgICAgICAgICAgICA9IE9iamVjdC5hc3NpZ24obWFjaGluZVJlZ2lzdGVyZWRCcm93c2VycywgdXNlclJlZ2lzdGVyZWRCcm93c2Vycyk7XG4gICAgY29uc3QgZWRnZUxlZ2FjeSAgICAgICAgICAgICAgICA9IGF3YWl0IGRldGVjdE1pY3Jvc29mdEVkZ2VMZWdhY3koKTtcblxuICAgIGlmIChlZGdlTGVnYWN5KVxuICAgICAgICBpbnN0YWxsYXRpb25zWydlZGdlLWxlZ2FjeSddID0gZWRnZUxlZ2FjeTtcblxuICAgIGlmIChlZGdlTGVnYWN5ICYmICFpbnN0YWxsYXRpb25zWydlZGdlJ10pXG4gICAgICAgIGluc3RhbGxhdGlvbnNbJ2VkZ2UnXSA9IGVkZ2VMZWdhY3k7XG5cbiAgICByZXR1cm4gaW5zdGFsbGF0aW9ucztcbn1cblxuYXN5bmMgZnVuY3Rpb24gZmluZE1hY0Jyb3dzZXJzICgpIHtcbiAgICB2YXIgaW5zdGFsbGF0aW9ucyA9IHt9O1xuXG4gICAgLy8gTk9URTogcmVwbGFjZSB0aGUgc3BhY2Ugc3ltYm9sIHdpdGggY29kZSwgYmVjYXVzZSBncmVwIHNwbGl0cyBzdHJpbmdzIGJ5IHNwYWNlLlxuICAgIHZhciBzdGRvdXQgPSBhd2FpdCBleGVjKE1BQ09TX0dFVF9CUk9XU0VSX0xJU1RfQ09NTUFORCk7XG5cbiAgICBhd2FpdCBQcm9taXNlLmFsbChzdGRvdXRcbiAgICAgICAgLnNwbGl0KCdcXG4nKVxuICAgICAgICAuZmlsdGVyKGZpbGVOYW1lID0+ICEhZmlsZU5hbWUpXG4gICAgICAgIC5tYXAoZmlsZU5hbWUgPT4ge1xuICAgICAgICAgICAgLy8gTk9URTogcmVzdG9yZSBzcGFjZVxuICAgICAgICAgICAgZmlsZU5hbWUgPSBmaWxlTmFtZS5yZXBsYWNlKC8wMzIvZywgJyAnKTtcblxuICAgICAgICAgICAgdmFyIG5hbWUgPSBmaWxlTmFtZS5yZXBsYWNlKC8uYXBwJC8sICcnKTtcbiAgICAgICAgICAgIHZhciBwYXRoID0gYC9BcHBsaWNhdGlvbnMvJHtmaWxlTmFtZX1gO1xuXG4gICAgICAgICAgICByZXR1cm4gYWRkSW5zdGFsbGF0aW9uKGluc3RhbGxhdGlvbnMsIG5hbWUsIHBhdGgpO1xuICAgICAgICB9KSk7XG5cbiAgICByZXR1cm4gaW5zdGFsbGF0aW9ucztcbn1cblxuYXN5bmMgZnVuY3Rpb24gZmluZExpbnV4QnJvd3NlcnMgKCkge1xuICAgIHZhciBpbnN0YWxsYXRpb25zID0ge307XG5cbiAgICB2YXIgYWxpYXNDaGVja2luZ1Byb21pc2VzID0gT2JqZWN0XG4gICAgICAgIC5rZXlzKEFMSUFTRVMpXG4gICAgICAgIC5tYXAobmFtZSA9PiB7XG4gICAgICAgICAgICB2YXIgeyBsaW51eEJpbmFyaWVzIH0gPSBBTElBU0VTW25hbWVdO1xuXG4gICAgICAgICAgICBpZiAoIWxpbnV4QmluYXJpZXMpXG4gICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XG5cbiAgICAgICAgICAgIHZhciBkZXRlY3Rpb25Qcm9taXNlcyA9IGxpbnV4QmluYXJpZXNcbiAgICAgICAgICAgICAgICAubWFwKGJpbmFyeSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB3aGljaChiaW5hcnkpXG4gICAgICAgICAgICAgICAgICAgICAgICAudGhlbihwYXRoID0+IGFkZEluc3RhbGxhdGlvbihpbnN0YWxsYXRpb25zLCBuYW1lLCBwYXRoKSlcbiAgICAgICAgICAgICAgICAgICAgICAgIC5jYXRjaCgoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gTk9URTogYmluYXJ5IG5vdCBmb3VuZCwganVzdCBkbyBub3RoaW5nXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLmFsbChkZXRlY3Rpb25Qcm9taXNlcyk7XG4gICAgICAgIH0pO1xuXG4gICAgYXdhaXQgUHJvbWlzZS5hbGwoYWxpYXNDaGVja2luZ1Byb21pc2VzKTtcblxuICAgIHJldHVybiBpbnN0YWxsYXRpb25zO1xufVxuXG5hc3luYyBmdW5jdGlvbiBmaW5kQnJvd3NlcnMgKCkge1xuICAgIGlmIChPUy53aW4pXG4gICAgICAgIHJldHVybiBhd2FpdCBmaW5kV2luZG93c0Jyb3dzZXJzKCk7XG5cbiAgICBpZiAoT1MubWFjKVxuICAgICAgICByZXR1cm4gYXdhaXQgZmluZE1hY0Jyb3dzZXJzKCk7XG5cbiAgICBpZiAoT1MubGludXgpXG4gICAgICAgIHJldHVybiBhd2FpdCBmaW5kTGludXhCcm93c2VycygpO1xuXG4gICAgcmV0dXJuIHt9O1xufVxuXG5cbi8vIEFQSVxuLyoqIEB0eXBlZGVmIHtPYmplY3R9IEJyb3dzZXJJbmZvXG4gKiBAZGVzY3JpcHRpb24gT2JqZWN0IHRoYXQgY29udGFpbnMgaW5mb3JtYXRpb24gYWJvdXQgdGhlIGJyb3dzZXIgaW5zdGFsbGVkIG9uIHRoZSBtYWNoaW5lLlxuICogQHByb3BlcnR5IHtzdHJpbmd8dW5kZWZpbmVkfSBwYXRoIC0gVGhlIHBhdGggdG8gdGhlIGV4ZWN1dGFibGUgZmlsZSB0aGF0IHN0YXJ0cyB0aGUgYnJvd3Nlci5cbiAqICBSZXF1aXJlZCBvbiBNYWNPUyBtYWNoaW5lcy4gT24gV2luZG93cyBtYWNoaW5lcywgaXQgaXMgdXNlZCB3aGVuIHRoZSB3aW5PcGVuQ21kVGVtcGxhdGUgcHJvcGVydHkgaXMgdW5kZWZpbmVkLlxuICogQHByb3BlcnR5IHtzdHJpbmd9IGNtZCAtIEFkZGl0aW9uYWwgY29tbWFuZCBsaW5lIHBhcmFtZXRlcnMuXG4gKiBAcHJvcGVydHkge3N0cmluZ30gbWFjT3BlbkNtZFRlbXBsYXRlIC0gQSBbTXVzdGFjaGUgdGVtcGxhdGVdKGh0dHBzOi8vZ2l0aHViLmNvbS9qYW5sL211c3RhY2hlLmpzI3RlbXBsYXRlcylcbiAqICB0aGF0IHByb3ZpZGVzIHBhcmFtZXRlcnMgZm9yIGxhdW5jaGluZyB0aGUgYnJvd3NlciBvbiBhIE1hY09TIG1hY2hpbmUuXG4gKiBAcHJvcGVydHkge3N0cmluZ3x1bmRlZmluZWR9IHdpbk9wZW5DbWRUZW1wbGF0ZSAtIEEgW011c3RhY2hlIHRlbXBsYXRlXShodHRwczovL2dpdGh1Yi5jb20vamFubC9tdXN0YWNoZS5qcyN0ZW1wbGF0ZXMpXG4gKiAgdGhhdCBwcm92aWRlcyBwYXJhbWV0ZXJzIGZvciBsYXVuY2hpbmcgdGhlIGJyb3dzZXIgb24gYSBXaW5kb3dzIG1hY2hpbmUuICBJZiB1bmRlZmluZWQsIHRoZSBwYXRoIHRvIHRoZVxuICogIGV4ZWN1dGFibGUgZmlsZSBzcGVjaWZpZWQgYnkgdGhlIHBhdGggcHJvcGVydHkgaXMgdXNlZC5cbiAqIEBleGFtcGxlXG4gKiAge1xuICogICAgICAgcGF0aDogJ0M6XFxcXFByb2dyYW1GaWxlc1xcXFwuLi5cXFxcZmlyZWZveC5leGUnLFxuICogICAgICAgY21kOiAnLW5ldy13aW5kb3cnLFxuICogICAgICAgbWFjT3BlbkNtZFRlbXBsYXRlOiAnb3BlbiAtYSBcInt7e3BhdGh9fX1cIiB7e3twYWdlVXJsfX19IC0tYXJncyB7e3tjbWR9fX0nXG4gKiAgfVxuICovXG5cbi8qKlxuICogUmV0dXJucyB0aGUgbGlzdCBvZiB0aGUge0BsaW5rIEJyb3dzZXJJbmZvfSBvYmplY3RzIHRoYXQgY29udGFpbiBpbmZvcm1hdGlvbiBhYm91dCB0aGUgYnJvd3NlcnMgaW5zdGFsbGVkIG9uIHRoZSBtYWNoaW5lLlxuICogQGZ1bmN0aW9uXG4gKiBAYXN5bmNcbiAqIEBuYW1lIGdldEluc3RhbGxhdGlvbnNcbiAqIEByZXR1cm5zIHtPYmplY3QuPHN0cmluZywgQnJvd3NlckluZm8+fSBMaXN0IG9mIHRoZSB7QGxpbmsgQnJvd3NlckluZm99IG9iamVjdHNcbiAqICAgY29udGFpbmluZyBpbmZvcm1hdGlvbiBhYm91dCB0aGUgYnJvd3NlcnMgaW5zdGFsbGVkIG9uIHRoZSBtYWNoaW5lLlxuICogQGV4YW1wbGVcbiAqIHtcbiAqICAgY2hyb21lOiB7XG4gKiAgICAgICBwYXRoOiAnQzpcXFxcUHJvZ3JhbUZpbGVzXFxcXC4uLlxcXFxjaHJvbWUuZXhlJyxcbiAqICAgICAgIGNtZDogJy0tbmV3LXdpbmRvdycsXG4gKiAgICAgICBtYWNPcGVuQ21kVGVtcGxhdGU6ICdvcGVuIC1uIC1hIFwie3t7cGF0aH19fVwiIC0tYXJncyB7e3twYWdlVXJsfX19IHt7e2NtZH19fSdcbiAqICAgfSxcbiAqXG4gKiAgIGZpcmVmb3g6IHtcbiAqICAgICAgIHBhdGg6ICdDOlxcXFxQcm9ncmFtRmlsZXNcXFxcLi4uXFxcXGZpcmVmb3guZXhlJyxcbiAqICAgICAgIGNtZDogJy1uZXctd2luZG93JyxcbiAqICAgICAgIG1hY09wZW5DbWRUZW1wbGF0ZTogJ29wZW4gLWEgXCJ7e3twYXRofX19XCIge3t7cGFnZVVybH19fSAtLWFyZ3Mge3t7Y21kfX19J1xuICogICB9XG4gKiB9XG4gKi9cbmV4cG9ydCBkZWZhdWx0IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICBpZiAoIWluc3RhbGxhdGlvbnNDYWNoZSlcbiAgICAgICAgaW5zdGFsbGF0aW9uc0NhY2hlID0gYXdhaXQgZmluZEJyb3dzZXJzKCk7XG5cbiAgICByZXR1cm4gaW5zdGFsbGF0aW9uc0NhY2hlO1xufVxuIl19